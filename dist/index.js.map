{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/index.tsx"],"sourcesContent":["import { Locale } from \".\";\n\nconst Ellipsis = \"...\";\n\nconst eleId = \"collapsible-paragraph-helper\";\n\nfunction getDummyContainer() {\n  let dummyContainer: HTMLDivElement;\n  return function (width: number, lineHeight: number) {\n    if (!dummyContainer) {\n      dummyContainer = document.createElement(\"div\");\n      dummyContainer.setAttribute(\"aria-hidden\", \"true\");\n      dummyContainer.id = eleId;\n      dummyContainer.style.position = \"fixed\";\n      dummyContainer.style.left = \"0\";\n      dummyContainer.style.width = `${width}px`;\n      dummyContainer.style.height = \"auto\";\n      dummyContainer.style.lineHeight = `${lineHeight}px`;\n      dummyContainer.style.minHeight = \"auto\";\n      dummyContainer.style.maxHeight = \"auto\";\n      dummyContainer.style.top = \"-999999px\";\n      dummyContainer.style.zIndex = \"9001\";\n      dummyContainer.style.textOverflow = \"clip\";\n      dummyContainer.style.whiteSpace = \"pre-wrap\";\n      dummyContainer.style.wordBreak = \"break-word\";\n      document.body.appendChild(dummyContainer);\n    }\n    if (dummyContainer.style.width !== `${width}px`) {\n      dummyContainer.style.width = `${width}px`;\n    }\n    return dummyContainer;\n  };\n}\n\nfunction generateHandlers(lineHeight: number, locales: Locale) {\n  const button = document.createElement(\"span\");\n  button.style.display = \"inline-block\";\n  button.style.lineHeight = `${lineHeight}px`;\n  button.style.height = `${lineHeight}px`;\n  button.style.marginLeft = \"4px\";\n  const label = document.createTextNode(locales.expand);\n  button.appendChild(label);\n  return button;\n}\n\nexport function getNumberFromPixel(pixel: string): number {\n  return Number(/\\d+/.exec(pixel)?.toString());\n}\n\nexport function compute(\n  originText: string,\n  maxWidth: number,\n  maxHeight: number,\n  lineHeight: number,\n  locales: Locale,\n  controlled: boolean,\n) {\n  const dummyContainer = getDummyContainer()(maxWidth, lineHeight);\n  const textNode = document.createTextNode(originText);\n  dummyContainer.appendChild(textNode);\n  if (dummyContainer.offsetHeight <= maxHeight) {\n    return { computed: false, text: originText };\n  }\n\n  originText += Ellipsis;\n\n  if (!controlled) {\n    dummyContainer.appendChild(generateHandlers(lineHeight, locales));\n  }\n\n  let start = 0;\n  let end = originText.length - 1;\n\n  while (start + 1 < end) {\n    const mid = Math.floor((start + end) / 2);\n    const curText = originText.slice(0, mid) + Ellipsis;\n    textNode.textContent = curText;\n    if (dummyContainer.offsetHeight <= maxHeight) {\n      start = mid;\n    } else {\n      end = mid;\n    }\n  }\n  textNode.textContent = originText.slice(0, start) + Ellipsis;\n  if (dummyContainer.offsetHeight <= maxHeight) {\n    return { text: originText.slice(0, start) + Ellipsis, computed: true };\n  }\n  return { text: originText.slice(0, end) + Ellipsis, computed: true };\n}\n","import React, { FC, useCallback, useEffect, useRef, useState } from \"react\";\n\nimport \"./style.scss\";\nimport { compute, getNumberFromPixel } from \"./utils\";\n\nexport type Locale = {\n  expand: string;\n  collapse: string;\n};\n\nexport interface CollapsibleParagraphProps {\n  lines: number;\n  expand?: boolean;\n  locales?: Locale;\n}\n\nconst CollapsibleParagraph: FC<CollapsibleParagraphProps> = ({\n  lines,\n  children,\n  locales,\n  expand,\n}) => {\n  const lastWidth = useRef<number>();\n  const originalText = useRef<string>();\n  const lastComputedText = useRef<string>();\n  const paragraph = useRef<HTMLParagraphElement | null>(null);\n  const observer = useRef<ResizeObserver>();\n\n  const [text, setText] = useState<string>();\n  const [showHandler, setShowHandler] = useState<boolean>(false);\n  const [isExpand, setIsExpand] = useState<boolean>(false);\n\n  const getComputedText = useCallback(\n    (originText: string, maxWidth: number, lineHeight: number) => {\n      return compute(\n        originText,\n        maxWidth,\n        lineHeight * lines,\n        lineHeight,\n        locales!,\n        typeof expand === \"boolean\",\n      );\n    },\n    [lines, locales, expand],\n  );\n\n  const toggleExpand = useCallback(() => {\n    if (isExpand) {\n      setText(lastComputedText.current);\n    } else {\n      setText(originalText.current);\n    }\n    setIsExpand(isExpand => !isExpand);\n  }, [isExpand]);\n\n  useEffect(() => {\n    if (typeof children !== \"string\") {\n      throw new Error(\"The type of children must be `string`\");\n    }\n    originalText.current = children;\n  }, [children]);\n\n  useEffect(() => {\n    if (\n      paragraph.current &&\n      paragraph.current.parentElement &&\n      originalText.current\n    ) {\n      let { lineHeight, paddingLeft, paddingRight } = window.getComputedStyle(\n        paragraph.current.parentElement,\n      );\n\n      let lineHeightNumber: number;\n\n      if (lineHeight === \"normal\") {\n        lineHeightNumber = 16;\n      } else {\n        lineHeightNumber = getNumberFromPixel(lineHeight);\n      }\n\n      // clear observer first\n      if (observer.current) {\n        observer.current.disconnect();\n      }\n\n      // update computation when container gets resized\n      observer.current = new ResizeObserver(entries => {\n        if (!originalText.current) return;\n        const container = entries[0];\n        const {\n          contentRect: { width },\n        } = container;\n\n        if (lastWidth.current === width) {\n          return;\n        }\n\n        lastWidth.current = width;\n\n        const computed = getComputedText(\n          originalText.current,\n          width -\n            getNumberFromPixel(paddingLeft) -\n            getNumberFromPixel(paddingRight),\n          lineHeightNumber,\n        );\n        console.log(computed);\n\n        setShowHandler(computed.computed);\n        if (!isExpand) {\n          setText(computed.text);\n        }\n        lastComputedText.current = computed.text;\n      });\n\n      // observe\n      observer.current.observe(paragraph.current.parentElement);\n    }\n    return () => {\n      if (observer.current) {\n        observer.current.disconnect();\n      }\n    };\n  }, [getComputedText, isExpand]);\n\n  return (\n    <p ref={paragraph} className=\"react-foldable-paragraph-v-1-0-0\">\n      {text}\n      {showHandler && (\n        <span\n          className=\"react-foldable-paragraph-v-1-0-0-handler\"\n          onClick={toggleExpand}\n        >\n          {isExpand ? locales?.collapse : locales?.expand}\n        </span>\n      )}\n    </p>\n  );\n};\n\nCollapsibleParagraph.defaultProps = {\n  lines: 2,\n  locales: {\n    expand: \"expand\",\n    collapse: \"collapse\",\n  },\n};\n\nexport default CollapsibleParagraph;\n"],"names":["useRef","useState","useCallback","useEffect","React"],"mappings":"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"}